<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>超级玛丽</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <link rel="stylesheet" href="asset/style.css"/>
</head>
<body>
<div id="mylegend"></div>
<div class="cover">
    <div class="center">
        <img src="asset/iphone.png" alt=""/>
        <p>请横屏浏览，谢谢！</p>
    </div>
</div>
<ul class="table">
    <li>SCROE<span class="score">0</span></li>
    <li>GOODS<span class="goods">0</span></li>
    <li>GOLD<span class="gold">0</span></li>
    <li>TIME<span class="time">0</span></li>
</ul>


<script type="text/javascript" src="asset/zepto.min.js"></script>
<script type="text/javascript" src="asset/lufylegend-1.10.1.js"></script>
<script type="text/javascript">
(function($){
    //横竖屏判断 
    function orient() { //console.log(window.orientation);
        if (window.orientation == 0 || window.orientation == 180) { $(".cover").show(); }
        else if (window.orientation == 90 || window.orientation == -90) { $(".cover").hide();init(50,"mylegend",1334,750,main);}
    };
    orient(); 
    var timer;
    $(window).bind("orientationchange", function(){clearTimeout(timer);timer = setTimeout(orient, 300);});


    if(LGlobal.mobile){//如果是移动端
        LGlobal.stageScale = LStageScaleMode.EXACT_FIT;//指定整个应用程序在指定区域中可见，但不尝试保持原始高宽比
        LSystem.screen(LStage.FULL_SCREEN);//全屏
    }

    var game={};
    game.options={
        w:1334,h:750,
    }


    //定义游戏基础数据
    var w=1334,h=750;//画布宽度和高度
    var loadLayer,hintLayer,gameLayer,endLayer;//加载页、游戏说明页、游戏界面、游戏结束页
    var score=0,goodsnum=0,goldnum=0,time=30,loadtxt;//得分、商品数量、金币数量、时间
    var player,goods=[],golds=[],enemy,gamebg;//角色、商品、金币、怪物、游戏背景
    var speed=10,skip=0,press=false; //游戏移动速度、跳起高度
    var imgdata=[//图片资源
        {name:'hintbg',path:'asset/hintbg.png'},
        {name:'gamebg',path:'asset/gamebg.png'},
        {name:'enemy',path:'asset/enemy.png'},
        {name:'gold',path:'asset/gold.png'},
        {name:'box',path:'asset/box.png'},
        {name:'player',path:'asset/player.png'}
    ];
    var imglist=[];//存储加载后的图片数组

    //初始化引擎
    init(50,"mylegend",w,h,main);

    //游戏主程序
    function main(){
        //加载页
        loadLayer = new LoadingSample5();//1-7种加载动画
        addChild(loadLayer);
        LLoadManage.load(
            imgdata,
            function(progress){loadLayer.setProgress(progress);},
            function(result){//加载完成移除加载页
                imglist = result;
                removeChild(loadLayer);
                loadLayer = null;
                //引入说明页
                hintLayer =new LSprite;
                addChild(hintLayer);
                console.log(imglist);
                var hintbg=new LBitmap(new LBitmapData(imglist["hintbg"]));
                hintLayer.addChild(hintbg);
                hintLayer.addEventListener(LMouseEvent.MOUSE_DOWN,function(){//点击开始游戏
                    removeChild(hintLayer);gameStart();
                });
            }
        )
    }
    /* @x @y 元件的位置
     * @imgname 图片资源的名称
     * @imgdata 图片截取的位置和宽高数组
     * @slicer  图片精灵的分割规则的数组，总宽，总高，行数，列数
     * @cut     使用splice截取分割后的数组的参数
    */
    function createAnimObj(x,y,imgname,imgdata,slicer){//添加动画元件
        var data=new LBitmapData(imglist[imgname],imgdata[0],imgdata[1],imgdata[2],imgdata[3])
        var list=LGlobal.divideCoordinate(slicer[0],slicer[1],slicer[2],slicer[3]);
        var mc = new LAnimation(gameLayer,data,list);
        mc.y=y;mc.x=x;return mc;
    }

    function creategolds(){//生成初始金币元件组
        var arrdata=[];
        var arr=[];
        for(var i=0;i<10;i++){
            var r1=Math.ceil(Math.random()*6);//1-5
            arrdata.push([1300+50*i,550-50*r1]);
        }
        arrdata.forEach(function(v){
            arr.push(new createAnimObj(v[0],v[1],'gold',[0,0,50,50],[250,50,1,5]))
        });
        return arr;
    }

    //游戏开始程序
    function gameStart(){
        $(".table").show();
        updateVal();
        gameLayer=new LSprite;
        addChild(gameLayer);
        gamebg=new LBitmap(new LBitmapData(imglist["gamebg"]));
        gameLayer.addChild(gamebg);

        player=new createAnimObj(100,h-150-120,'player',[0,0,54,120],[432,120,1,8]);
        enemy=new createAnimObj(1334,h-150-74,'enemy',[0,0,80,34],[240,34,1,3]);
        box=new createAnimObj(500,350,'box',[0,0,50,50],[200,100,2,4]);
        golds=creategolds();

        gameLayer.addEventListener(LEvent.ENTER_FRAME,onframe);//播放事件
        gameLayer.addEventListener(LMouseEvent.MOUSE_DOWN,onDown);//点击事件
       
    }

    //更新游戏数据
    function updateVal(a,b,c,d){
        $(".table").find(".score").text(a);
        $(".table").find(".goods").text(b);
        $(".table").find(".gold").text(c);
        $(".table").find(".time").text(d);
    }

    //游戏倒计时
    var timer=setTimeout(function(){timeac()},1000)
    function timeac(){if(time===0){console.log('game over');}else{time--;score+=2;timer=setTimeout(function(){timeac()},1000)}}

    //系统刷屏事件
    function onframe(){
        //背景动画
        if(gamebg.x<-825){gamebg.x+=825;};gamebg.x-=speed;

        //角色动画
        if(skip>0 && skip<20){if(press){skip--;}else{skip++}}else{skip=0;press=false;player.onframe();}
        player.y=Math.pow((skip-10),2)*3-300+h-150-120;

        //敌人动画        
        enemy.onframe();
        enemy.x-=2*speed;
        if(enemy.x<-100){enemy=new createAnimObj(1334+Math.ceil(Math.random()*3000),h-150-74,'enemy',[0,0,80,34],[240,34,1,3]);}
        if(LGlobal.hitTestArc(player,enemy)){ console.log('game over')};//碰到敌人的碰撞检测

        box.onframe();
        box.x-=speed;
        if(LGlobal.hitTestArc(player,box)){ box.setAction(1,0,0,false); press=true; };

        //金币元件组动画
        golds.forEach(function(v,k){
            v.onframe();v.x-=speed;
            var ishit=LGlobal.hitTestArc(player,v);//获取金币的碰撞检测
            if(ishit || v.x<-100){
                golds.splice(k,1);//在数组中删除已获取或已遗失的金币，并在后面push一个进来
                gameLayer.removeChild(v);
                if(ishit){goldnum++;score+=10;}
                if(golds.length<10){golds.push(new createAnimObj(1300,550-50*Math.ceil(Math.random()*6),'gold',[0,0,50,50],[250,50,1,5]))}
            };

        })
        
        
        //更新文本数值
        updateVal(score,goodsnum,goldnum,time);
    }
    function onDown(){if(skip===0){skip=1;}}

    
}(Zepto))
    

   
</script>

</body>
</html>